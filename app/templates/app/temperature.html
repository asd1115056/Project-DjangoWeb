{% extends "app/base.html" %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.3.1/justgage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">


<div class="row clearfix">
    <div class="col-md-2 column">
        <div style="text-align:center;"><h3>Location</h3><br></div>
        <ul class="nav nav-pills nav-stacked">
            {% for app in apps %}
            <li class="index {% if forloop.first %} autoload active {% endif %}" device_id="{{app.device_id}}">
                <a data-toggle="tab" href="">{% if app.device_name %} {{app.device_name}} {% else %} {{app.device_id}} {% endif %}</a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="col-md-10 column">
        <div class="row clearfix">
            <div class="col-md-3 column">
                <div style="text-align:center;"><h3>Temperature</h3><br></div>
                <div id="gauge1" style=" height:150px;text-align:center"></div>
            </div>
            <div class="col-md-9 column">
                <br>
                <div id="container" style="min-width: 700px; height: 300px; margin: 0 auto"></div>
                <div class="btn-group pull-right">
                    <button type="button" class="btn btn-default">1 hours</button>
                    <button type="button" class="btn btn-default">6 hours</button>
                    <button type="button" class="btn btn-default">12 hours</button>
                    <div class="btn-group" style="margin-left:-1px;">
                        <div class="dropdown pull-right">
                            <button type="button" style="border-radius:0;border-bottom-right-radius: 4px;border-top-right-radius: 4px;" class="btn btn-default dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">More<span class="caret"></span></button>
                            <div class="dropdown-menu" style="width:305px;padding-right: 5px;padding-left: 5px;" role="menu" aria-labelledby="dropdownMenu1">
                                <form class="form-inline" role="form" style="margin-bottom: 0px;">
                                    <div class="form-group" style="width:100px;">
                                        <input type="text" class="form-control" id="name"
                                               placeholder="">
                                    </div>
                                    <h>~</h>
                                    <div class="form-group" style="width:100px;">
                                        <input type="text" class="form-control" id="name"
                                               placeholder="">
                                    </div>
                                    <button type="button" class="btn btn-default">Search</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        function autoload() {
            device_id = $(".autoload").attr('device_id');
            var i = device_id.localeCompare("undefined") //比較兩字串:相等=0
            if (i != 0) {//取不相等時的值
                data = { 'device_id': device_id }
            }
            $.ajax({
                url: "{% url 'env_get_id' %}",
                type: 'GET',
                data: data,
                success: function (response) {
                    console.log(response);
                    clearPlot()
                    requestData()
                    setTimeout(refresh, 200);
                },
                error: function () {
                    //console.log('error');
                },
            });
            //console.log(data);
        }
        window.onload = autoload();
        window.onload = setTimeout(refresh, 100) //第一次刷新數據
        var i;
        $(".index").click(function () { //點擊事件
            device_id = $(this).attr('device_id'),
                i = device_id.localeCompare("undefined") //比較兩字串:相等=0
            if (i != 0) {//取不相等時的值
                data = { 'device_id': device_id }
                //console.log(data);
            }
            $.ajax({
                url: "{% url 'env_get_id' %}",
                type: 'GET',
                data: data,
                success: function (response) {
                    console.log(response);
                    clearPlot()
                    requestData()
                    setTimeout(refresh, 200);
                },
                error: function () {
                    //console.log('error');
                },
            });
        });
    });
    function Flatpickr(i) {
        document.getElementsByClassName("Date" + i).flatpickr({
            enableTime: true,
            dateFormat: "Y-m-d",
            minDate: "2020-01"
            //maxDate: "15.12.2017"
        });
    }
    var chart;
    $(document).ready(function () {
        Highcharts.setOptions({ global: { useUTC: false } });
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                type: 'spline',
                events: {
                    load: requestData
                }
            },
            credits: {
                enabled: false // remove high chart logo hyper-link
            },
            title: {
                text: ""
            },
            xAxis: {
                title: { text: 'datetime' },
                type: 'datetime',
                labels: {
                    format: '{value:%m-%d %H:%M}',
                }
            },
            yAxis: {
                title: {
                    text: 'Temperature (°C)'
                },
                labels: {
                    formatter: function () {
                        return this.value + '°';
                    }
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            exporting: {
                enabled: false
            },
            legend: {
                layout: 'vertical',
                align: 'center',
                verticalAlign: 'top',

                borderWidth: 0
            },
            tooltip: {
                valueSuffix: '°C'
            },
            plotOptions: {
                series: {
                    events: {
                        legendItemClick: function (e) {
                            return false; // 禁用點擊隱藏數據列
                        }
                    }
                }
            }

        });
    });

    function clearPlot() {
        //console.log("clear plot data!!!");
        var series = chart.series;
        while (series.length > 0) {
            series[0].remove(false);
        }
    }

    function requestData() {
        $.ajax({
            url: "{% url 'env_filter_latest' %}",
            type: "GET",
            dataType: "json",
            success: function (data) {
                var len = Object.keys(data).length;
                var seriesData = [];
                var chartName = data[0].fields.location_code;
                for (var j = 0; j < len; j++) {
                    var x = new Date(data[j].fields.updated_at).getTime();
                    var y = data[j].fields.temperature;
                    x = parseFloat(x)
                    y = parseFloat(y)
                    seriesData.push([x, y]);
                }
                chart.addSeries({
                    location_code: chartName,
                    data: seriesData,
                    zones: [{
                        value: 0,
                        color: '#f7a35c',
                        dashStyle: 'dot'
                    }, {
                        value: 10,
                        color: '#7cb5ec'
                    }, {
                        color: '#90ed7d'
                    }]
                });
            },
            cache: false
        });
    }

    var gage;
    function refresh() {
        $.ajax({
            url: "{% url 'env_filter_latest' %}",
            type: "GET",
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data.length != 0) {
                    var x = new Date(data[0].fields.updated_at).getTime();
                    var y = data[0].fields.temperature;
                } else {
                    x = 0;
                    y = 0;
                }
                //console.log([y, x]);
                if (!gage) {
                    gage = new JustGage({
                        id: "gauge1",
                        value: y,
                        min: 0,
                        max: 100,
                        label: "°C",
                    });
                } else {
                    gage.refresh(y);
                }
            }
        });
    }
    setTimeout(refresh, 100) //第一次刷新數據
</script>
{% endblock %}