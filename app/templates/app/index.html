{% extends "app/base.html" %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.3.1/justgage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="row clearfix">
    <div class="col-md-2 column">
        <div style="text-align:center;"><h3>Location</h3><br></div>
        <ul class="nav nav-pills nav-stacked">
            {% for app in apps %}
            <li class="index {% if forloop.first %} autoload active {% endif %}" device_id="{{app.device_id}}">
                <a data-toggle="tab" href="">{% if app.device_name %} {{app.device_name}} {% else %} {{app.device_id}} {% endif %}</a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="col-md-10 column">
        <div class="tabbable" id="tabs-613039">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#panel-924845" data-toggle="tab">Temperature</a>
                </li>
                <li>
                    <a href="#panel-375536" data-toggle="tab">Humidity</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="panel-924845">
                    <div class="row clearfix">
                        <div class="col-md-3 column">
                            <div style="vertical-align:middle;text-align:center;"><h2>Temperature</h2><br></div>
                            <div id="gauge1" style=" width:200px;height:100px;vertical-align:middle;text-align:center"></div>
                        </div>
                        <div class="col-md-9 column">
                            <br>
                            <div id="container1" style="min-width: 700px; height: 300px; margin: 0 auto"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="panel-375536">
                    <div class="row clearfix">
                        <div class="col-md-3 column">
                            <div style="vertical-align:middle;text-align:center;"><h2>Humidity</h2><br></div>
                            <div id="gauge2" style=" width:200px;height:100px;vertical-align:middle;text-align:center"></div>
                        </div>
                        <div class="col-md-9 column">
                            <br>
                            <div id="container2" style="min-width: 700px; height: 300px; margin: 0 auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    setTimeout(refresh, 100) //第一次刷新數據
    function refresh() {
        var gage1, gage2;
        $.ajax({
            url: "{% url 'env_filter_latest' %}",
            type: "GET",
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data.length != 0) {
                    var x = data[0].fields.temperature;
                    var y = data[0].fields.humidity;
                } else {
                    x = 0;
                    y = 0;
                }
                //console.log([y, x]);
                if (!gage1 && !gage2) {
                    gage1 = new JustGage({
                        id: "gauge1",
                        value: x,
                        min: 0,
                        max: 100,
                        label: "°C",
                    });
                    gage2 = new JustGage({
                        id: "gauge2",
                        value: y,
                        min: 0,
                        max: 100,
                        label: "°%",
                    });
                } else {
                    gage1.refresh(x);
                    gage2.refresh(y);
                }
            }
        });
    }
</script>

<script>
    $(function () {
        setTimeout(requestData, 500)
        var chart1 = Highcharts.chart('container1', {
            credits: {
                enabled: false // remove high chart logo hyper-link
            },
            title: {
                text: ""
            },
            xAxis: {
                title: { text: 'datetime' },
                type: 'datetime',
                labels: {
                    format: '{value:%m-%d %H:%M}',
                }
            },
            yAxis: {
                title: {
                    text: 'Temperature (°C)'
                },
                labels: {
                    formatter: function () {
                        return this.value + '°';
                    }
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            exporting: {
                enabled: false
            },
            legend: {
                layout: 'vertical',
                align: 'center',
                verticalAlign: 'top',

                borderWidth: 0
            },
            tooltip: {
                valueSuffix: '°C'
            },
            plotOptions: {
                series: {
                    events: {
                        legendItemClick: function (e) {
                            return false; // 禁用點擊隱藏數據列
                        }
                    }
                }
            }, series: [{
            }]
        });
        var chart2 = Highcharts.chart('container2', {
            credits: {
                enabled: false // remove high chart logo hyper-link
            },
            title: {
                text: ""
            },
            xAxis: {
                title: { text: 'datetime' },
                type: 'datetime',
                labels: {
                    format: '{value:%m-%d %H:%M}',
                }
            },
            yAxis: {
                title: {
                    text: 'Humidity (%)'
                },
                labels: {
                    formatter: function () {
                        return this.value + '°';
                    }
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            exporting: {
                enabled: false
            },
            legend: {
                layout: 'vertical',
                align: 'center',
                verticalAlign: 'top',

                borderWidth: 0
            },
            tooltip: {
                valueSuffix: '%'
            },
            plotOptions: {
                series: {
                    events: {
                        legendItemClick: function (e) {
                            return false; // 禁用點擊隱藏數據列
                        }
                    }
                }
            },
            series: [{
            }]
        });
        function requestData() {
            $.ajax({
                url: "https://raw.githubusercontent.com/asd1115056/Project-DjangoWeb/master/env.json",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var len = Object.keys(data).length;
                    var seriesData1 = [];
                    var seriesData2 = [];
                    //console.log(data);
                    //var chartName = data[0].fields.location_id;
                    for (var j = 0; j < len; j++) {
                        var time = new Date(data[j].fields.updated_at).getTime();
                        var temperature = data[j].fields.temperature;
                        var humidity = data[j].fields.humidity;
                        time = parseFloat(time)
                        temperature = parseFloat(temperature)
                        humidity = parseFloat(humidity)
                        seriesData1.push([time, temperature]);
                        seriesData2.push([time, humidity]);
                    }
                    chart1.series[0].update({
                        name: "Temperature",
                        data: seriesData1
                    });
                    chart2.series[0].update({
                        name: "Humidity",
                        data: seriesData2
                    });
                },
            });
        }
    });
</script>
{% endblock %}
